<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏≠ÊñáÂ≠¶‰π† - Road to H1 Chinese</title>
    <style>
        /* (CSS styles as in the prompt) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%), 
                        url('https://images.unsplash.com/photo-1508804185872-d7badad00f7d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80') center/cover no-repeat fixed;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.75);
            padding: 40px 30px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .header .chinese-title {
            font-size: 1.8rem;
            color: #c53030;
            margin-bottom: 15px;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.75);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.5);
        }

        .feature-title {
            font-size: 1.5rem;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-icon {
            font-size: 1.8rem;
        }

        .upload-area {
            border: 2px dashed rgba(203, 213, 224, 0.8);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: linear-gradient(45deg, rgba(247, 250, 252, 0.8), rgba(237, 242, 247, 0.8));
            backdrop-filter: blur(10px);
        }

        .upload-area:hover {
            border-color: #667eea;
            background: linear-gradient(45deg, #edf2f7, #e2e8f0);
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: #a0aec0;
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .result-area {
            background: rgba(247, 250, 252, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            min-height: 100px;
            border: 1px solid rgba(226, 232, 240, 0.6);
            backdrop-filter: blur(10px);
        }

        .chinese-text {
            font-size: 1.2rem;
            color: #2d3748;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .pinyin-text {
            font-size: 1rem;
            color: #718096;
            font-style: italic;
        }

        .tts-section {
            margin-top: 20px;
        }

        .text-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .voice-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .voice-option {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .voice-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .voice-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .voice-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .voice-description {
            font-size: 0.9rem;
            color: #718096;
        }

        .voice-option.selected .voice-description {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Dictionary Styles */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
        }

        .dictionary-result {
            background: rgba(247, 250, 252, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid rgba(226, 232, 240, 0.6);
            backdrop-filter: blur(10px);
            display: none;
        }

        .dictionary-result.show {
            display: block;
        }

        .word-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .chinese-character {
            font-size: 2.5rem;
            color: #2d3748;
            font-weight: bold;
        }

        .pinyin-display {
            font-size: 1.2rem;
            color: #667eea;
            font-weight: 500;
        }

        .definition-section {
            margin-bottom: 15px;
        }

        .definition-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .definition-text {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 5px;
        }

        .example-sentence {
            background: #edf2f7;
            padding: 10px;
            border-radius: 8px;
            margin-top: 8px;
            font-style: italic;
            color: #2d3748;
        }

        .search-history {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .history-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .history-item {
            background: #f7fafc;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            background: #edf2f7;
        }

        .history-char {
            font-weight: bold;
            color: #2d3748;
        }

        .history-pinyin {
            color: #718096;
            font-size: 0.9rem;
        }

        .clear-history {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .clear-history:hover {
            background: #c53030;
        }

        /* Learning History Styles */
        .history-controls .btn {
            transition: all 0.3s ease;
        }

        .history-controls .btn.active {
            background: linear-gradient(135deg, #48bb78, #38a169);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .history-item-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(226, 232, 240, 0.6);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .history-item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-item-type {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .history-item-time {
            color: #718096;
            font-size: 0.9rem;
        }

        .history-item-content {
            margin: 10px 0;
        }

        .history-item-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .history-item-details {
            color: #4a5568;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .history-item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .history-item-actions .btn {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.6);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(226, 232, 240, 0.4);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }

        .empty-history {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .empty-history-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speed-slider {
            width: 100px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-weight: bold;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header .chinese-title {
                font-size: 1.5rem;
            }

            .chinese-character {
                font-size: 2rem;
            }

            .word-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Road to H1 Chinese</h1>
            <div class="chinese-title">‰∏≠ÊñáÂ≠¶‰π†‰∏≠ÂøÉ</div>
            <p>Advanced AI-powered tools for university students learning Chinese</p>
        </div>

        <div class="main-content">
            <!-- Image to Caption Section -->
            <div class="feature-card">
                <h2 class="feature-title">
                    <span class="feature-icon">üì∏</span>
                    Image to Chinese Caption
                </h2>
                <p style="margin-bottom: 20px; color: #718096;">Upload an image and get Chinese descriptions with pinyin pronunciation</p>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <p style="margin-bottom: 10px;"><strong>Click to upload</strong> or drag and drop an image here</p>
                    <p style="font-size: 0.9rem; color: #a0aec0;">Supported formats: JPG, PNG, WebP</p>
                    <input type="file" id="imageInput" class="file-input" accept="image/*">
                </div>

                <div id="imagePreview"></div>

                <div class="loading" id="captionLoading">
                    <div class="spinner"></div>
                    <p>Analyzing image and generating Chinese caption...</p>
                </div>

                <div class="result-area" id="captionResult">
                    <p style="color: #a0aec0; text-align: center;">Upload an image to see the Chinese caption here</p>
                </div>

                <button class="btn" onclick="generateCaption()">Generate Caption</button>
            </div>

            <!-- Text to Speech Section -->
            <div class="feature-card">
                <h2 class="feature-title">
                    <span class="feature-icon">üîä</span>
                    Chinese Text to Speech
                </h2>
                <p style="margin-bottom: 20px; color: #718096;">Enter Chinese text and listen to native Mandarin pronunciation</p>

                <textarea 
                    id="ttsText" 
                    class="text-input" 
                    placeholder="ËæìÂÖ•‰∏≠ÊñáÊñáÊú¨... (Enter Chinese text here)"
                >‰Ω†Â•ΩÔºåÊ¨¢ËøéÊù•Âà∞‰∏≠ÊñáÂ≠¶‰π†‰∏≠ÂøÉÔºÅ</textarea>

                <div class="tts-section">
                    <h3 style="margin-bottom: 15px; color: #2d3748;">Choose Voice Style:</h3>
                    <div class="voice-selector">
                        <div class="voice-option selected" data-voice="female-standard">
                            <div class="voice-name">Ê†áÂáÜÊôÆÈÄöËØù (Standard Mandarin)</div>
                            <div class="voice-description">Clear, professional Mandarin</div>
                        </div>
                        <div class="voice-option" data-voice="male-standard">
                            <div class="voice-name">Ê†áÂáÜÁ≤§ËØ≠ (Standard Cantonese)</div>
                            <div class="voice-description">Clear, professional Cantonese</div>
                        </div>
                    </div>

                    <div class="controls">
                        <button class="btn" onclick="speakText()">üîä Speak</button>
                        <button class="btn" onclick="stopSpeaking()">‚èπ Stop</button>
                        <div class="speed-control">
                            <label for="speedSlider">Speed:</label>
                            <input type="range" id="speedSlider" class="speed-slider" min="0.5" max="2" step="0.1" value="1">
                            <span id="speedValue">1.0x</span>
                        </div>
                    </div>

                    <div class="loading" id="ttsLoading">
                        <div class="spinner"></div>
                        <p>Generating speech...</p>
                    </div>
                </div>
            </div>

            <!-- Chinese Dictionary Section -->
            <div class="feature-card">
                <h2 class="feature-title">
                    <span class="feature-icon">üìö</span>
                    Chinese Dictionary
                </h2>
                <p style="margin-bottom: 20px; color: #718096;">Search Chinese characters and words with detailed definitions and pronunciations</p>

                <div class="search-container">
                    <input 
                        type="text" 
                        id="dictionarySearch" 
                        class="search-input" 
                        placeholder="ËæìÂÖ•Ê±âÂ≠óÊàñÊãºÈü≥... (Enter Chinese characters or pinyin)"
                        onkeypress="handleDictionarySearch(event)"
                    >
                    <button class="search-btn" onclick="searchDictionary()">üîç</button>
                </div>

                <div style="margin: 15px 0; text-align: center;">
                    <p style="font-size: 0.9rem; color: #718096; margin-bottom: 10px;">Try these sample words:</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                        <button class="btn" onclick="searchSample('‰Ω†Â•Ω')" style="padding: 5px 10px; font-size: 0.8rem;">‰Ω†Â•Ω</button>
                        <button class="btn" onclick="searchSample('Â≠¶‰π†')" style="padding: 5px 10px; font-size: 0.8rem;">Â≠¶‰π†</button>
                        <button class="btn" onclick="searchSample('Â§ßÂ≠¶')" style="padding: 5px 10px; font-size: 0.8rem;">Â§ßÂ≠¶</button>
                        <button class="btn" onclick="searchSample('‰∏≠ÂõΩ')" style="padding: 5px 10px; font-size: 0.8rem;">‰∏≠ÂõΩ</button>
                        <button class="btn" onclick="searchSample('ËÄÅÂ∏à')" style="padding: 5px 10px; font-size: 0.8rem;">ËÄÅÂ∏à</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="testWebCrawling()" style="padding: 8px 15px; font-size: 0.8rem; background: linear-gradient(135deg, #48bb78, #38a169);">
                            üåê Test Web Crawling
                        </button>
                    </div>
                </div>

                <div class="loading" id="dictionaryLoading">
                    <div class="spinner"></div>
                    <p id="loadingText">Searching dictionary...</p>
                </div>

                <div class="dictionary-result" id="dictionaryResult">
                    <p style="color: #a0aec0; text-align: center;">Search for a Chinese character or word to see its definition</p>
                </div>

            </div>
        </div>

        <!-- Learning History Section -->
        <div class="feature-card" style="grid-column: 1 / -1; margin-top: 20px;">
            <h2 class="feature-title">
                <span class="feature-icon">üìä</span>
                Learning History & Progress
            </h2>
            <p style="margin-bottom: 20px; color: #718096;">Track your Chinese learning journey and see your progress</p>

            <div class="history-controls" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn" onclick="showAllHistory()" id="allHistoryBtn">All Activities</button>
                <button class="btn" onclick="showDictionaryHistory()" id="dictHistoryBtn">Dictionary Searches</button>
                <button class="btn" onclick="showImageHistory()" id="imageHistoryBtn">Image Captions</button>
                <button class="btn" onclick="showTTSHistory()" id="ttsHistoryBtn">Text-to-Speech</button>
                <button class="btn" onclick="showProgressStats()" id="statsBtn">üìà Statistics</button>
                <button class="btn" onclick="clearAllHistory()" style="background: linear-gradient(135deg, #e53e3e, #c53030);">üóëÔ∏è Clear All</button>
            </div>

            <div class="history-search-container" style="margin-bottom: 20px;">
                <div class="search-container" style="max-width: 500px; margin: 0 auto; position: relative;">
                    <input 
                        type="text" 
                        id="historySearch" 
                        class="search-input" 
                        placeholder="Search your learning history... (e.g., ‰Ω†Â•Ω, image, tts)"
                        onkeypress="handleHistorySearch(event)"
                        oninput="filterHistoryBySearch()"
                    >
                    <button class="search-btn" onclick="filterHistoryBySearch()">üîç</button>
                    <button class="search-btn" onclick="clearHistorySearch()" style="right: 50px; background: linear-gradient(135deg, #e53e3e, #c53030);">‚úï</button>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <small style="color: #718096;">Search by Chinese characters, pinyin, English words, or activity type (dictionary, image, tts)</small>
                </div>
            </div>

            <div class="history-stats" id="historyStats" style="display: none; background: rgba(247, 250, 252, 0.8); padding: 20px; border-radius: 15px; margin-bottom: 20px; backdrop-filter: blur(10px);">
                <h3 style="margin-bottom: 15px; color: #2d3748;">Your Learning Statistics</h3>
                <div id="statsContent"></div>
            </div>

            <div class="history-content" id="historyContent">
                <div class="history-list" id="historyList">
                    <p style="color: #a0aec0; text-align: center; padding: 40px;">Your learning history will appear here. Start using the features to build your progress!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedVoice = 'female-standard';
        let currentUtterance = null;
        let searchHistory = JSON.parse(localStorage.getItem('chineseDictionaryHistory') || '[]');
        let learningHistory = JSON.parse(localStorage.getItem('learningHistory') || '[]');
        let currentFilter = 'all';
        let currentSearchTerm = '';

        // Image Upload Functionality
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const captionResult = document.getElementById('captionResult');
        const captionLoading = document.getElementById('captionLoading');

        uploadArea.addEventListener('click', () => imageInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageUpload(files[0]);
            }
        });

        imageInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageUpload(e.target.files[0]);
            }
        });

        function handleImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please upload a valid image file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.innerHTML = `<img src="${e.target.result}" alt="Uploaded image" class="image-preview">`;
            };
            reader.readAsDataURL(file);
        }

        function generateCaption() {
            const img = imagePreview.querySelector('img');
            if (!img) {
                alert('Please upload an image first.');
                return;
            }

            captionLoading.classList.add('show');
            captionResult.innerHTML = '';

            // Simulate AI processing (replace with actual API call)
            setTimeout(() => {
                const sampleCaptions = [
                    {
                        chinese: "‰∏ÄÂè™ÂèØÁà±ÁöÑÂ∞èÁå´ÂùêÂú®Á™óÂè∞‰∏äÔºåÈò≥ÂÖâÈÄèËøáÁ™óÊà∑ÁÖßÂ∞ÑËøõÊù•„ÄÇ",
                        pinyin: "yƒ´ zhƒ´ kƒõ √†i de xi«éo mƒÅo zu√≤ z√†i chuƒÅng t√°i sh√†ng, y√°ng guƒÅng t√≤u gu√≤ chuƒÅng h√π zh√†o sh√® j√¨n l√°i."
                    },
                    {
                        chinese: "Áæé‰∏ΩÁöÑÂ±±Ê∞¥È£éÊôØÁîªÔºåÈùíÂ±±ÁªøÊ∞¥Ôºå‰∫ëÈõæÁº≠Áªï„ÄÇ",
                        pinyin: "mƒõi l√¨ de shƒÅn shu«ê fƒìng j«êng hu√†, qƒ´ng shƒÅn l«ú shu«ê, y√∫n w√π li√°o r√†o."
                    },
                    {
                        chinese: "Áé∞‰ª£ÂåñÁöÑÂüéÂ∏ÇË°óÈÅìÔºåÈ´òÊ•ºÂ§ßÂé¶ÊûóÁ´ãÔºåËΩ¶ËæÜÂ∑ùÊµÅ‰∏çÊÅØ„ÄÇ",
                        pinyin: "xi√†n d√†i hu√† de ch√©ng sh√¨ jiƒì d√†o, gƒÅo l√≥u d√† sh√† l√≠n l√¨, chƒì li√†ng chuƒÅn li√∫ b√π xƒ´."
                    }
                ];

                const randomCaption = sampleCaptions[Math.floor(Math.random() * sampleCaptions.length)];
                
                captionLoading.classList.remove('show');
                captionResult.innerHTML = `
                    <div class="chinese-text">${randomCaption.chinese}</div>
                    <div class="pinyin-text">${randomCaption.pinyin}</div>
                    <button class="btn" onclick="speakCaption('${randomCaption.chinese}')" style="margin-top: 10px;">üîä Listen to Caption</button>
                `;
                
                // Add to learning history
                addToLearningHistory('image', {
                    chinese: randomCaption.chinese,
                    pinyin: randomCaption.pinyin,
                    imageUrl: img.src
                });
            }, 2000);
        }

        function speakCaption(text) {
            document.getElementById('ttsText').value = text;
            speakText();
        }

        // Voice Selection
        document.querySelectorAll('.voice-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.voice-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                selectedVoice = option.dataset.voice;
            });
        });

        // Speed Control
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');

        speedSlider.addEventListener('input', () => {
            speedValue.textContent = speedSlider.value + 'x';
        });


        function stopSpeaking() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            document.getElementById('ttsLoading').classList.remove('show');
        }

        // Load voices when available
        function loadVoices() {
            speechSynthesis.getVoices();
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        
        // Load voices initially
        loadVoices();

        // Dictionary Functionality
        function handleDictionarySearch(event) {
            if (event.key === 'Enter') {
                searchDictionary();
            }
        }

        async function searchDictionary() {
            const searchTerm = document.getElementById('dictionarySearch').value.trim();
            if (!searchTerm) {
                alert('Please enter a Chinese character or word to search.');
                return;
            }

            const loading = document.getElementById('dictionaryLoading');
            const loadingText = document.getElementById('loadingText');
            const result = document.getElementById('dictionaryResult');
            
            loading.classList.add('show');
            result.classList.remove('show');

            try {
                console.log('Searching for:', searchTerm);
                
                // Update loading text to show crawling status
                loadingText.textContent = 'üåê Crawling MDBG dictionary...';
                
                const dictionaryData = await fetchDictionaryData(searchTerm);
                console.log('Dictionary data received:', dictionaryData);
                
                // Show success message briefly
                loadingText.textContent = '‚úÖ Data retrieved successfully!';
                await new Promise(resolve => setTimeout(resolve, 500));
                
                displayDictionaryResult(dictionaryData, dictionaryData.source || 'fallback');
                addToSearchHistory(searchTerm, dictionaryData.pinyin);
                
                // Add to learning history
                addToLearningHistory('dictionary', {
                    character: searchTerm,
                    pinyin: dictionaryData.pinyin,
                    definitions: dictionaryData.definitions,
                    source: dictionaryData.source || 'fallback'
                });
                
            } catch (error) {
                console.error('Dictionary search error:', error);
                result.innerHTML = `
                    <div style="color: #e53e3e; text-align: center; padding: 20px;">
                        <p>Error searching dictionary. Please try again.</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Try searching for: ‰Ω†Â•Ω, Â≠¶‰π†, Â§ßÂ≠¶, ‰∏≠ÂõΩ, ËÄÅÂ∏à, Â≠¶Áîü, ÊúãÂèã, ÂÆ∂Â∫≠, Â∑•‰Ωú, Êó∂Èó¥</p>
                    </div>
                `;
                result.classList.add('show');
            } finally {
                loading.classList.remove('show');
                loadingText.textContent = 'Searching dictionary...';
            }
        }

        async function fetchDictionaryData(searchTerm) {
            try {
                // Try web crawling MDBG dictionary first
                console.log('Attempting to crawl MDBG dictionary for:', searchTerm);
                const crawledData = await crawlMDBGDictionary(searchTerm);
                if (crawledData && crawledData.definitions.length > 0) {
                    console.log('Successfully crawled MDBG data:', crawledData);
                    crawledData.source = 'crawled';
                    return crawledData;
                }
            } catch (error) {
                console.log('MDBG crawling failed:', error);
            }

            try {
                // Try using a Chinese dictionary API that works with CORS
                const response = await fetch(`https://api.allsetlearning.com/cjk/char/${encodeURIComponent(searchTerm)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.definitions) {
                        return {
                            character: searchTerm,
                            pinyin: data.pinyin || generatePinyin(searchTerm),
                            definitions: data.definitions.map(def => ({
                                partOfSpeech: def.pos || 'unknown',
                                meaning: def.definition,
                                examples: def.examples || []
                            }))
                        };
                    }
                }
            } catch (error) {
                console.log('Primary API failed, trying alternative...');
            }

            try {
                // Alternative: Try a different free API
                const response = await fetch(`https://api.zhconvert.org/convert?text=${encodeURIComponent(searchTerm)}&format=pinyin`);
                
                if (response.ok) {
                    const data = await response.json();
                    return {
                        character: searchTerm,
                        pinyin: data.pinyin || generatePinyin(searchTerm),
                        definitions: [{
                            partOfSpeech: 'character',
                            meaning: 'Chinese character - check our sample data for detailed definitions',
                            examples: []
                        }]
                    };
                }
            } catch (error) {
                console.log('Alternative API failed, using fallback data');
            }

            // Fallback to comprehensive sample data
            const sampleData = {
                '‰Ω†Â•Ω': {
                    character: '‰Ω†Â•Ω',
                    pinyin: 'n«ê h«éo',
                    definitions: [
                        {
                            partOfSpeech: 'greeting',
                            meaning: 'Hello; Hi - a common greeting in Chinese',
                            examples: ['‰Ω†Â•ΩÔºåÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†ÔºÅ', '‰Ω†Â•ΩÂêóÔºü', '‰Ω†Â•ΩÔºåÊàëÊòØÂ∞èÊòé„ÄÇ']
                        }
                    ]
                },
                'Â≠¶‰π†': {
                    character: 'Â≠¶‰π†',
                    pinyin: 'xu√© x√≠',
                    definitions: [
                        {
                            partOfSpeech: 'verb',
                            meaning: 'to study; to learn; to acquire knowledge',
                            examples: ['ÊàëÂú®Â≠¶‰π†‰∏≠Êñá„ÄÇ', 'Â≠¶‰π†Êñ∞Áü•ËØÜÂæàÈáçË¶Å„ÄÇ', '‰ªñÂ≠¶‰π†ÂæàÂä™Âäõ„ÄÇ']
                        }
                    ]
                },
                'Â§ßÂ≠¶': {
                    character: 'Â§ßÂ≠¶',
                    pinyin: 'd√† xu√©',
                    definitions: [
                        {
                            partOfSpeech: 'noun',
                            meaning: 'university; college; higher education institution',
                            examples: ['ÊàëÂú®Âåó‰∫¨Â§ßÂ≠¶Â≠¶‰π†„ÄÇ', 'Â§ßÂ≠¶ÊïôËÇ≤ÂæàÈáçË¶Å„ÄÇ', 'ËøôÊâÄÂ§ßÂ≠¶ÂæàÊúâÂêç„ÄÇ']
                        }
                    ]
                },
                '‰∏≠ÂõΩ': {
                    character: '‰∏≠ÂõΩ',
                    pinyin: 'zh≈çng gu√≥',
                    definitions: [
                        {
                            partOfSpeech: 'noun',
                            meaning: 'China; the People\'s Republic of China',
                            examples: ['‰∏≠ÂõΩÊòØ‰∏Ä‰∏™Áæé‰∏ΩÁöÑÂõΩÂÆ∂„ÄÇ', 'ÊàëÊù•Ëá™‰∏≠ÂõΩ„ÄÇ', '‰∏≠ÂõΩÊúâÂæàÈïøÁöÑÂéÜÂè≤„ÄÇ']
                        }
                    ]
                },
                'ËÄÅÂ∏à': {
                    character: 'ËÄÅÂ∏à',
                    pinyin: 'l«éo shƒ´',
                    definitions: [
                        {
                            partOfSpeech: 'noun',
                            meaning: 'teacher; instructor; educator',
                            examples: ['ÊàëÁöÑ‰∏≠ÊñáËÄÅÂ∏àÂæàÂ•Ω„ÄÇ', 'ËÄÅÂ∏àÊïôÊàë‰ª¨Â≠¶‰π†„ÄÇ', '‰ªñÊòØ‰∏Ä‰ΩçÂ•ΩËÄÅÂ∏à„ÄÇ']
                        }
                    ]
                },
                'Â≠¶Áîü': {
                    character: 'Â≠¶Áîü',
                    pinyin: 'xu√© shƒìng',
                    definitions: [
                        {
                            partOfSpeech: 'noun',
                            meaning: 'student; pupil; learner',
                            examples: ['ÊàëÊòØ‰∏Ä‰∏™Â≠¶Áîü„ÄÇ', 'Â≠¶Áîü‰ª¨Âú®ÊïôÂÆ§ÈáåÂ≠¶‰π†„ÄÇ', 'Â•ΩÂ≠¶ÁîüÈÉΩÂæàÂä™Âäõ„ÄÇ']
                        }
                    ]
                },
                'ÊúãÂèã': {
                    character: 'ÊúãÂèã',
                    pinyin: 'p√©ng y«íu',
                    definitions: [
                        {
                            partOfSpeech: 'noun',
                            meaning: 'friend; companion',
                            examples: ['‰ªñÊòØÊàëÁöÑÂ•ΩÊúãÂèã„ÄÇ', 'Êàë‰ª¨ÊúâÂæàÂ§öÊúãÂèã„ÄÇ', 'ÊúãÂèã‰πãÈó¥Ë¶Å‰∫íÁõ∏Â∏ÆÂä©„ÄÇ']
                        }
                    ]
                },
                'ÂÆ∂Â∫≠': {
                    character: 'ÂÆ∂Â∫≠',
                    pinyin: 'jiƒÅ t√≠ng',
                    definitions: [
                        {
                            partOfSpeech: 'noun',
                            meaning: 'family; household',
                            examples: ['ÊàëÊúâ‰∏Ä‰∏™Âπ∏Á¶èÁöÑÂÆ∂Â∫≠„ÄÇ', 'ÂÆ∂Â∫≠ÊàêÂëòË¶Å‰∫íÁõ∏Áà±Êä§„ÄÇ', 'ÂÆ∂Â∫≠ÂæàÈáçË¶Å„ÄÇ']
                        }
                    ]
                },
                'Â∑•‰Ωú': {
                    character: 'Â∑•‰Ωú',
                    pinyin: 'g≈çng zu√≤',
                    definitions: [
                        {
                            partOfSpeech: 'noun/verb',
                            meaning: 'work; job; to work',
                            examples: ['ÊàëÁöÑÂ∑•‰ΩúÂæàÊúâË∂£„ÄÇ', '‰ªñÂ∑•‰ΩúÂæàËÆ§Áúü„ÄÇ', 'Â∑•‰ΩúË¶ÅËÆ§ÁúüË¥üË¥£„ÄÇ']
                        }
                    ]
                },
                'Êó∂Èó¥': {
                    character: 'Êó∂Èó¥',
                    pinyin: 'sh√≠ jiƒÅn',
                    definitions: [
                        {
                            partOfSpeech: 'noun',
                            meaning: 'time; period; duration',
                            examples: ['Êó∂Èó¥ËøáÂæóÂæàÂø´„ÄÇ', 'ÊàëÊ≤°ÊúâÊó∂Èó¥„ÄÇ', 'Êó∂Èó¥Â∞±ÊòØÈáëÈí±„ÄÇ']
                        }
                    ]
                }
            };

            return sampleData[searchTerm] || {
                character: searchTerm,
                pinyin: generatePinyin(searchTerm),
                definitions: [{
                    partOfSpeech: 'unknown',
                    meaning: 'Definition not found. This might be a character or word not in our dictionary yet.',
                    examples: []
                }]
            };
        }

        async function crawlMDBGDictionary(searchTerm) {
            try {
                // Use a CORS proxy to access MDBG dictionary
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const mdbgUrl = `https://www.mdbg.net/chinese/dictionary?page=worddict&wdrst=0&wdqb=${encodeURIComponent(searchTerm)}`;
                const fullUrl = proxyUrl + encodeURIComponent(mdbgUrl);
                
                console.log('Crawling URL:', fullUrl);
                
                const response = await fetch(fullUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const html = await response.text();
                console.log('HTML received, length:', html.length);
                
                return parseMDBGHTML(html, searchTerm);
                
            } catch (error) {
                console.error('Error crawling MDBG:', error);
                throw error;
            }
        }

        function parseMDBGHTML(html, searchTerm) {
            try {
                // Create a temporary DOM parser
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Look for the main content area
                const mainContent = doc.querySelector('.word-dict') || doc.querySelector('.results') || doc.querySelector('body');
                
                if (!mainContent) {
                    throw new Error('Could not find main content area');
                }
                
                // Extract pinyin from the page
                let pinyin = generatePinyin(searchTerm);
                const pinyinElements = doc.querySelectorAll('.pinyin, .pronunciation, [class*="pinyin"]');
                for (let element of pinyinElements) {
                    const text = element.textContent.trim();
                    if (text && /[a-zƒÅ√°«é√†ƒì√©ƒõ√®ƒ´√≠«ê√¨≈ç√≥«í√≤≈´√∫«î√π«ñ«ò«ö«ú]/.test(text)) {
                        pinyin = text;
                        break;
                    }
                }
                
                // Extract definitions
                const definitions = [];
                
                // Look for definition lists or tables
                const definitionElements = doc.querySelectorAll('.definition, .meaning, .def, [class*="def"], .word-meaning, .entry-definition');
                
                for (let element of definitionElements) {
                    const text = element.textContent.trim();
                    if (text && text.length > 3 && !text.includes('MDBG') && !text.includes('dictionary')) {
                        definitions.push({
                            partOfSpeech: 'definition',
                            meaning: text,
                            examples: []
                        });
                    }
                }
                
                // If no definitions found, try alternative selectors
                if (definitions.length === 0) {
                    const altElements = doc.querySelectorAll('p, div, span, li');
                    for (let element of altElements) {
                        const text = element.textContent.trim();
                        if (text && text.length > 10 && text.length < 200 && 
                            !text.includes('MDBG') && !text.includes('dictionary') &&
                            !text.includes('search') && !text.includes('results')) {
                            
                            // Check if it looks like a definition
                            if (text.includes(searchTerm) || /[a-zA-Z]/.test(text)) {
                                definitions.push({
                                    partOfSpeech: 'definition',
                                    meaning: text,
                                    examples: []
                                });
                                
                                if (definitions.length >= 3) break; // Limit to 3 definitions
                            }
                        }
                    }
                }
                
                // If still no definitions, try to extract from the page text
                if (definitions.length === 0) {
                    const bodyText = doc.body.textContent;
                    const lines = bodyText.split('\n').map(line => line.trim()).filter(line => line.length > 5);
                    
                    for (let line of lines) {
                        if (line.includes(searchTerm) && line.length > 10 && line.length < 300) {
                            definitions.push({
                                partOfSpeech: 'definition',
                                meaning: line,
                                examples: []
                            });
                            
                            if (definitions.length >= 2) break;
                        }
                    }
                }
                
                console.log('Parsed definitions:', definitions);
                
                return {
                    character: searchTerm,
                    pinyin: pinyin,
                    definitions: definitions.length > 0 ? definitions : [{
                        partOfSpeech: 'character',
                        meaning: `Chinese character "${searchTerm}" - definition not found in MDBG`,
                        examples: []
                    }]
                };
                
            } catch (error) {
                console.error('Error parsing MDBG HTML:', error);
                throw error;
            }
        }

        function generatePinyin(text) {
            // Simple pinyin generation for common characters
            const pinyinMap = {
                '‰Ω†': 'n«ê', 'Â•Ω': 'h«éo', 'Â≠¶': 'xu√©', '‰π†': 'x√≠', 'Â§ß': 'd√†', '‰∏≠': 'zh≈çng', 'ÂõΩ': 'gu√≥',
                'ËÄÅ': 'l«éo', 'Â∏à': 'shƒ´', 'Áîü': 'shƒìng', 'Êúã': 'p√©ng', 'Âèã': 'y«íu', 'ÂÆ∂': 'jiƒÅ', 'Â∫≠': 't√≠ng',
                'Â∑•': 'g≈çng', '‰Ωú': 'zu√≤', 'Êó∂': 'sh√≠', 'Èó¥': 'jiƒÅn', 'Êàë': 'w«í', 'ÊòØ': 'sh√¨', '‰∏Ä': 'yƒ´',
                '‰∏™': 'g√®', 'ÁöÑ': 'de', 'Âú®': 'z√†i', 'Âæà': 'hƒõn', 'Êúâ': 'y«íu', 'Âíå': 'h√©', '‰∫Ü': 'le',
                '‰∏ç': 'b√π', 'Ë¶Å': 'y√†o', '‰ºö': 'hu√¨', 'Êù•': 'l√°i', 'Âà∞': 'd√†o', 'Âéª': 'q√π', '‰∏ä': 'sh√†ng',
                '‰∏ã': 'xi√†', 'Èáå': 'l«ê', 'Â§ñ': 'w√†i', 'Ââç': 'qi√°n', 'Âêé': 'h√≤u', 'Â∑¶': 'zu«í', 'Âè≥': 'y√≤u'
            };
            
            return text.split('').map(char => pinyinMap[char] || char).join(' ');
        }

        function displayDictionaryResult(data, source = 'fallback') {
            const result = document.getElementById('dictionaryResult');
            
            let html = `
                <div class="word-header">
                    <div class="chinese-character">${data.character}</div>
                    <div class="pinyin-display">${data.pinyin}</div>
                    <button class="btn" onclick="speakText('${data.character}')" style="margin-left: auto;">üîä</button>
                </div>
                <div style="text-align: center; margin-bottom: 15px;">
                    <span style="font-size: 0.8rem; color: #718096; background: #f7fafc; padding: 4px 8px; border-radius: 12px;">
                        ${source === 'crawled' ? 'üåê Live data from MDBG' : 'üìö Local dictionary'}
                    </span>
                </div>
            `;

            data.definitions.forEach((def, index) => {
                html += `
                    <div class="definition-section">
                        <div class="definition-title">${def.partOfSpeech.charAt(0).toUpperCase() + def.partOfSpeech.slice(1)}</div>
                        <div class="definition-text">${def.meaning}</div>
                        ${def.examples.length > 0 ? `
                            <div class="example-sentence">
                                <strong>Examples:</strong><br>
                                ${def.examples.map(example => `‚Ä¢ ${example}`).join('<br>')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            result.innerHTML = html;
            result.classList.add('show');
        }

        function addToSearchHistory(character, pinyin) {
            // Remove if already exists
            searchHistory = searchHistory.filter(item => item.character !== character);
            
            // Add to beginning
            searchHistory.unshift({ character, pinyin, timestamp: Date.now() });
            
            // Keep only last 10 searches
            searchHistory = searchHistory.slice(0, 10);
            
            // Save to localStorage
            localStorage.setItem('chineseDictionaryHistory', JSON.stringify(searchHistory));
            
            // Update display
            updateSearchHistoryDisplay();
        }

        function updateSearchHistoryDisplay() {
            const historyContainer = document.getElementById('searchHistory');
            const historyList = document.getElementById('historyList');
            
            if (searchHistory.length === 0) {
                historyContainer.style.display = 'none';
                return;
            }
            
            historyContainer.style.display = 'block';
            
            historyList.innerHTML = searchHistory.map(item => `
                <div class="history-item" onclick="searchFromHistory('${item.character}')">
                    <div>
                        <div class="history-char">${item.character}</div>
                        <div class="history-pinyin">${item.pinyin}</div>
                    </div>
                </div>
            `).join('');
        }

        function searchFromHistory(character) {
            document.getElementById('dictionarySearch').value = character;
            searchDictionary();
        }

        function clearSearchHistory() {
            searchHistory = [];
            localStorage.removeItem('chineseDictionaryHistory');
            updateSearchHistoryDisplay();
        }

        function searchSample(character) {
            document.getElementById('dictionarySearch').value = character;
            searchDictionary();
        }

        async function testWebCrawling() {
            const testWords = ['‰Ω†Â•Ω', 'Â≠¶‰π†', 'Â§ßÂ≠¶', '‰∏≠ÂõΩ', 'ËÄÅÂ∏à'];
            const randomWord = testWords[Math.floor(Math.random() * testWords.length)];
            
            document.getElementById('dictionarySearch').value = randomWord;
            
            const loading = document.getElementById('dictionaryLoading');
            const loadingText = document.getElementById('loadingText');
            const result = document.getElementById('dictionaryResult');
            
            loading.classList.add('show');
            result.classList.remove('show');
            loadingText.textContent = 'üåê Testing web crawling with MDBG...';
            
            try {
                const crawledData = await crawlMDBGDictionary(randomWord);
                crawledData.source = 'crawled';
                
                loadingText.textContent = '‚úÖ Web crawling successful!';
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                displayDictionaryResult(crawledData, 'crawled');
                addToSearchHistory(randomWord, crawledData.pinyin);
                
            } catch (error) {
                console.error('Web crawling test failed:', error);
                result.innerHTML = `
                    <div style="color: #e53e3e; text-align: center; padding: 20px;">
                        <p>Web crawling test failed. This is normal if:</p>
                        <ul style="text-align: left; margin: 10px 0; font-size: 0.9rem;">
                            <li>CORS proxy is blocked</li>
                            <li>MDBG website is down</li>
                            <li>Network connection issues</li>
                        </ul>
                        <p>Falling back to local dictionary data...</p>
                    </div>
                `;
                result.classList.add('show');
                
                // Fallback to local data
                setTimeout(() => {
                    const localData = getLocalDictionaryData(randomWord);
                    displayDictionaryResult(localData, 'fallback');
                }, 2000);
            } finally {
                loading.classList.remove('show');
                loadingText.textContent = 'Searching dictionary...';
            }
        }

        function getLocalDictionaryData(searchTerm) {
            const sampleData = {
                '‰Ω†Â•Ω': {
                    character: '‰Ω†Â•Ω',
                    pinyin: 'n«ê h«éo',
                    definitions: [
                        {
                            partOfSpeech: 'greeting',
                            meaning: 'Hello; Hi - a common greeting in Chinese',
                            examples: ['‰Ω†Â•ΩÔºåÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†ÔºÅ', '‰Ω†Â•ΩÂêóÔºü', '‰Ω†Â•ΩÔºåÊàëÊòØÂ∞èÊòé„ÄÇ']
                        }
                    ]
                },
                'Â≠¶‰π†': {
                    character: 'Â≠¶‰π†',
                    pinyin: 'xu√© x√≠',
                    definitions: [
                        {
                            partOfSpeech: 'verb',
                            meaning: 'to study; to learn; to acquire knowledge',
                            examples: ['ÊàëÂú®Â≠¶‰π†‰∏≠Êñá„ÄÇ', 'Â≠¶‰π†Êñ∞Áü•ËØÜÂæàÈáçË¶Å„ÄÇ', '‰ªñÂ≠¶‰π†ÂæàÂä™Âäõ„ÄÇ']
                        }
                    ]
                },
                'Â§ßÂ≠¶': {
                    character: 'Â§ßÂ≠¶',
                    pinyin: 'd√† xu√©',
                    definitions: [
                        {
                            partOfSpeech: 'noun',
                            meaning: 'university; college; higher education institution',
                            examples: ['ÊàëÂú®Âåó‰∫¨Â§ßÂ≠¶Â≠¶‰π†„ÄÇ', 'Â§ßÂ≠¶ÊïôËÇ≤ÂæàÈáçË¶Å„ÄÇ', 'ËøôÊâÄÂ§ßÂ≠¶ÂæàÊúâÂêç„ÄÇ']
                        }
                    ]
                },
                '‰∏≠ÂõΩ': {
                    character: '‰∏≠ÂõΩ',
                    pinyin: 'zh≈çng gu√≥',
                    definitions: [
                        {
                            partOfSpeech: 'noun',
                            meaning: 'China; the People\'s Republic of China',
                            examples: ['‰∏≠ÂõΩÊòØ‰∏Ä‰∏™Áæé‰∏ΩÁöÑÂõΩÂÆ∂„ÄÇ', 'ÊàëÊù•Ëá™‰∏≠ÂõΩ„ÄÇ', '‰∏≠ÂõΩÊúâÂæàÈïøÁöÑÂéÜÂè≤„ÄÇ']
                        }
                    ]
                },
                'ËÄÅÂ∏à': {
                    character: 'ËÄÅÂ∏à',
                    pinyin: 'l«éo shƒ´',
                    definitions: [
                        {
                            partOfSpeech: 'noun',
                            meaning: 'teacher; instructor; educator',
                            examples: ['ÊàëÁöÑ‰∏≠ÊñáËÄÅÂ∏àÂæàÂ•Ω„ÄÇ', 'ËÄÅÂ∏àÊïôÊàë‰ª¨Â≠¶‰π†„ÄÇ', '‰ªñÊòØ‰∏Ä‰ΩçÂ•ΩËÄÅÂ∏à„ÄÇ']
                        }
                    ]
                }
            };

            return sampleData[searchTerm] || {
                character: searchTerm,
                pinyin: generatePinyin(searchTerm),
                definitions: [{
                    partOfSpeech: 'character',
                    meaning: 'Definition not found in local dictionary',
                    examples: []
                }]
            };
        }

        // Enhanced TTS with better voice options
        function speakText(text = null) {
            const textToSpeak = text || document.getElementById('ttsText').value.trim();
            if (!textToSpeak) {
                alert('Please enter some Chinese text to speak.');
                return;
            }

            stopSpeaking();

            if ('speechSynthesis' in window) {
                currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
                currentUtterance.lang = 'zh-CN';
                currentUtterance.rate = parseFloat(document.getElementById('speedSlider').value);
                
                // Enhanced voice selection
                const voices = speechSynthesis.getVoices();
                const chineseVoices = voices.filter(voice => 
                    voice.lang.includes('zh') || 
                    voice.lang.includes('cmn') || 
                    voice.lang.includes('yue')
                );
                
                if (chineseVoices.length > 0) {
                    let selectedVoiceObj = chineseVoices[0];
                    
                    // More sophisticated voice selection
                    switch(selectedVoice) {
                        case 'female-standard':
                            selectedVoiceObj = chineseVoices.find(v => 
                                v.name.toLowerCase().includes('female') || 
                                v.name.toLowerCase().includes('Â•≥') ||
                                v.name.toLowerCase().includes('mandarin')
                            ) || chineseVoices[0];
                            currentUtterance.pitch = 1.0;
                            break;
                        case 'male-standard':
                            selectedVoiceObj = chineseVoices.find(v => 
                                v.name.toLowerCase().includes('male') || 
                                v.name.toLowerCase().includes('Áî∑') ||
                                v.name.toLowerCase().includes('cantonese')
                            ) || chineseVoices[1] || chineseVoices[0];
                            currentUtterance.pitch = 0.9;
                            break;
                    }
                    
                    currentUtterance.voice = selectedVoiceObj;
                }

                currentUtterance.onstart = () => {
                    document.getElementById('ttsLoading').classList.add('show');
                };

                currentUtterance.onend = () => {
                    document.getElementById('ttsLoading').classList.remove('show');
                };

                currentUtterance.onerror = () => {
                    document.getElementById('ttsLoading').classList.remove('show');
                    alert('Error occurred during speech synthesis. Please try again.');
                };

                speechSynthesis.speak(currentUtterance);
                
                // Add to learning history
                addToLearningHistory('tts', {
                    text: textToSpeak,
                    voice: selectedVoice,
                    speed: parseFloat(document.getElementById('speedSlider').value)
                });
            } else {
                alert('Text-to-speech is not supported in your browser.');
            }
        }

        // Learning History Functions
        function addToLearningHistory(type, data) {
            const historyItem = {
                id: Date.now(),
                type: type,
                timestamp: new Date().toISOString(),
                data: data
            };
            
            learningHistory.unshift(historyItem);
            
            // Keep only last 100 items
            if (learningHistory.length > 100) {
                learningHistory = learningHistory.slice(0, 100);
            }
            
            localStorage.setItem('learningHistory', JSON.stringify(learningHistory));
            updateLearningHistoryDisplay();
        }

        function updateLearningHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            let filteredHistory = filterHistory(learningHistory, currentFilter);
            
            // Apply search filter if there's a search term
            if (currentSearchTerm) {
                filteredHistory = searchInHistory(filteredHistory, currentSearchTerm);
            }
            
            if (filteredHistory.length === 0) {
                const emptyMessage = currentSearchTerm ? 
                    `No activities found matching "${currentSearchTerm}"` : 
                    `No ${currentFilter === 'all' ? 'activities' : currentFilter} found in your learning history.`;
                
                historyList.innerHTML = `
                    <div class="empty-history">
                        <div class="empty-history-icon">${currentSearchTerm ? 'üîç' : 'üìö'}</div>
                        <p>${emptyMessage}</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">${currentSearchTerm ? 'Try a different search term or clear the search.' : 'Start using the features to build your progress!'}</p>
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = filteredHistory.map(item => createHistoryItemHTML(item)).join('');
        }

        function filterHistory(history, filter) {
            if (filter === 'all') return history;
            return history.filter(item => item.type === filter);
        }

        function createHistoryItemHTML(item) {
            const timeAgo = getTimeAgo(new Date(item.timestamp));
            const typeInfo = getTypeInfo(item.type);
            
            return `
                <div class="history-item-card">
                    <div class="history-item-header">
                        <span class="history-item-type">${typeInfo.icon} ${typeInfo.name}</span>
                        <span class="history-item-time">${timeAgo}</span>
                    </div>
                    <div class="history-item-content">
                        <div class="history-item-title">${getItemTitle(item)}</div>
                        <div class="history-item-details">${getItemDetails(item)}</div>
                    </div>
                    <div class="history-item-actions">
                        ${getItemActions(item)}
                    </div>
                </div>
            `;
        }

        function getTypeInfo(type) {
            const types = {
                'dictionary': { name: 'Dictionary Search', icon: 'üìö' },
                'image': { name: 'Image Caption', icon: 'üì∏' },
                'tts': { name: 'Text-to-Speech', icon: 'üîä' }
            };
            return types[type] || { name: 'Activity', icon: 'üìù' };
        }

        function getItemTitle(item) {
            switch(item.type) {
                case 'dictionary':
                    return `Searched for "${item.data.character}"`;
                case 'image':
                    return `Generated caption for image`;
                case 'tts':
                    return `Spoke: "${item.data.text.substring(0, 30)}${item.data.text.length > 30 ? '...' : ''}"`;
                default:
                    return 'Learning Activity';
            }
        }

        function getItemDetails(item) {
            switch(item.type) {
                case 'dictionary':
                    return `Pinyin: ${item.data.pinyin} | Found ${item.data.definitions.length} definition(s)`;
                case 'image':
                    return `Chinese: ${item.data.chinese} | Pinyin: ${item.data.pinyin}`;
                case 'tts':
                    return `Voice: ${item.data.voice} | Speed: ${item.data.speed}x`;
                default:
                    return 'Learning activity details';
            }
        }

        function getItemActions(item) {
            let actions = '';
            
            switch(item.type) {
                case 'dictionary':
                    actions += `<button class="btn" onclick="searchFromHistory('${item.data.character}')">Search Again</button>`;
                    actions += `<button class="btn" onclick="speakText('${item.data.character}')">üîä Speak</button>`;
                    break;
                case 'image':
                    actions += `<button class="btn" onclick="speakText('${item.data.chinese}')">üîä Speak Caption</button>`;
                    break;
                case 'tts':
                    actions += `<button class="btn" onclick="speakText('${item.data.text}')">üîä Speak Again</button>`;
                    break;
            }
            
            actions += `<button class="btn" onclick="removeHistoryItem(${item.id})" style="background: linear-gradient(135deg, #e53e3e, #c53030);">üóëÔ∏è Remove</button>`;
            
            return actions;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        function removeHistoryItem(id) {
            learningHistory = learningHistory.filter(item => item.id !== id);
            localStorage.setItem('learningHistory', JSON.stringify(learningHistory));
            updateLearningHistoryDisplay();
        }

        // History Filter Functions
        function showAllHistory() {
            currentFilter = 'all';
            updateActiveButton('allHistoryBtn');
            updateLearningHistoryDisplay();
        }

        function showDictionaryHistory() {
            currentFilter = 'dictionary';
            updateActiveButton('dictHistoryBtn');
            updateLearningHistoryDisplay();
        }

        function showImageHistory() {
            currentFilter = 'image';
            updateActiveButton('imageHistoryBtn');
            updateLearningHistoryDisplay();
        }

        function showTTSHistory() {
            currentFilter = 'tts';
            updateActiveButton('ttsHistoryBtn');
            updateLearningHistoryDisplay();
        }

        function updateActiveButton(activeId) {
            document.querySelectorAll('.history-controls .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');
        }

        function showProgressStats() {
            const statsContainer = document.getElementById('historyStats');
            const statsContent = document.getElementById('statsContent');
            
            if (statsContainer.style.display === 'none') {
                const stats = calculateLearningStats();
                statsContent.innerHTML = createStatsHTML(stats);
                statsContainer.style.display = 'block';
                updateActiveButton('statsBtn');
            } else {
                statsContainer.style.display = 'none';
                updateActiveButton('allHistoryBtn');
            }
        }

        function calculateLearningStats() {
            const totalActivities = learningHistory.length;
            const dictionarySearches = learningHistory.filter(item => item.type === 'dictionary').length;
            const imageCaptions = learningHistory.filter(item => item.type === 'image').length;
            const ttsUsage = learningHistory.filter(item => item.type === 'tts').length;
            
            const uniqueWords = new Set(learningHistory
                .filter(item => item.type === 'dictionary')
                .map(item => item.data.character)
            ).size;
            
            const lastWeek = learningHistory.filter(item => {
                const itemDate = new Date(item.timestamp);
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                return itemDate > weekAgo;
            }).length;
            
            return {
                totalActivities,
                dictionarySearches,
                imageCaptions,
                ttsUsage,
                uniqueWords,
                lastWeek
            };
        }

        function createStatsHTML(stats) {
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalActivities}</div>
                        <div class="stat-label">Total Activities</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.dictionarySearches}</div>
                        <div class="stat-label">Dictionary Searches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.imageCaptions}</div>
                        <div class="stat-label">Image Captions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.ttsUsage}</div>
                        <div class="stat-label">TTS Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.uniqueWords}</div>
                        <div class="stat-label">Unique Words Learned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.lastWeek}</div>
                        <div class="stat-label">Activities This Week</div>
                    </div>
                </div>
            `;
        }

        function clearAllHistory() {
            if (confirm('Are you sure you want to clear all learning history? This action cannot be undone.')) {
                learningHistory = [];
                localStorage.removeItem('learningHistory');
                updateLearningHistoryDisplay();
                document.getElementById('historyStats').style.display = 'none';
            }
        }

        // History Search Functions
        function handleHistorySearch(event) {
            if (event.key === 'Enter') {
                filterHistoryBySearch();
            }
        }

        function filterHistoryBySearch() {
            const searchInput = document.getElementById('historySearch');
            currentSearchTerm = searchInput.value.trim().toLowerCase();
            updateLearningHistoryDisplay();
        }

        function searchInHistory(history, searchTerm) {
            if (!searchTerm) return history;
            
            return history.filter(item => {
                const searchableText = getSearchableText(item).toLowerCase();
                return searchableText.includes(searchTerm);
            });
        }

        function getSearchableText(item) {
            let text = '';
            
            switch(item.type) {
                case 'dictionary':
                    text = `${item.data.character} ${item.data.pinyin} ${item.data.definitions.map(d => d.meaning).join(' ')}`;
                    break;
                case 'image':
                    text = `${item.data.chinese} ${item.data.pinyin}`;
                    break;
                case 'tts':
                    text = item.data.text;
                    break;
            }
            
            // Add type name for searching by activity type
            text += ` ${item.type} dictionary image tts`;
            
            return text;
        }

        function clearHistorySearch() {
            document.getElementById('historySearch').value = '';
            currentSearchTerm = '';
            updateLearningHistoryDisplay();
        }

        // Initialize search history display on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSearchHistoryDisplay();
            updateLearningHistoryDisplay();
        });
    </script>
</body>
</html>
